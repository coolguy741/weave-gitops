From b4f2dc055cc01e6f8eb8ec84f6b5681c71140655 Mon Sep 17 00:00:00 2001
From: Jordan Pellizzari <jordan@weave.works>
Date: Tue, 15 Feb 2022 10:20:46 -0800
Subject: [PATCH] Fix bad wego app permissions and silence profiles

---
 cmd/gitops/ui/run/cmd.go                      | 45 +++++++++----------
 go.mod                                        |  2 +-
 .../{deployment.yaml.tpl => deployment.yaml}  |  6 +--
 ...r_role.yaml.tpl => helm_watcher_role.yaml} |  0
 ...aml.tpl => helm_watcher_role_binding.yaml} |  2 +-
 ...ole-binding.yaml.tpl => role-binding.yaml} |  4 +-
 manifests/wego-app/role.yaml                  | 30 +++++++++++++
 manifests/wego-app/role.yaml.tpl              | 27 -----------
 ...-account.yaml.tpl => service-account.yaml} |  2 +-
 .../{service.yaml.tpl => service.yaml}        |  2 +-
 tools/wego-app-dev.yaml                       |  7 +--
 11 files changed, 62 insertions(+), 65 deletions(-)
 rename manifests/wego-app/{deployment.yaml.tpl => deployment.yaml} (72%)
 rename manifests/wego-app/{helm_watcher_role.yaml.tpl => helm_watcher_role.yaml} (100%)
 rename manifests/wego-app/{helm_watcher_role_binding.yaml.tpl => helm_watcher_role_binding.yaml} (89%)
 rename manifests/wego-app/{role-binding.yaml.tpl => role-binding.yaml} (80%)
 create mode 100644 manifests/wego-app/role.yaml
 delete mode 100644 manifests/wego-app/role.yaml.tpl
 rename manifests/wego-app/{service-account.yaml.tpl => service-account.yaml} (82%)
 rename manifests/wego-app/{service.yaml.tpl => service.yaml} (85%)

diff --git a/cmd/gitops/ui/run/cmd.go b/cmd/gitops/ui/run/cmd.go
index f51453b1..1085fdca 100644
--- a/cmd/gitops/ui/run/cmd.go
+++ b/cmd/gitops/ui/run/cmd.go
@@ -22,7 +22,6 @@ import (
 	"go.uber.org/zap"
 
 	"github.com/weaveworks/weave-gitops/cmd/gitops/cmderrors"
-	"github.com/weaveworks/weave-gitops/pkg/helm/watcher"
 	"github.com/weaveworks/weave-gitops/pkg/helm/watcher/cache"
 	"github.com/weaveworks/weave-gitops/pkg/kube"
 	"github.com/weaveworks/weave-gitops/pkg/server"
@@ -142,34 +141,34 @@ func runCmd(cmd *cobra.Command, args []string) error {
 		return fmt.Errorf("could not create client config: %w", err)
 	}
 
-	_, rawClient, err := kube.NewKubeHTTPClientWithConfig(rest, clusterName)
-	if err != nil {
-		return fmt.Errorf("could not create kube http client: %w", err)
-	}
+	// _, rawClient, err := kube.NewKubeHTTPClientWithConfig(rest, clusterName)
+	// if err != nil {
+	// 	return fmt.Errorf("could not create kube http client: %w", err)
+	// }
 
 	profileCache, err := cache.NewCache(options.ProfileCacheLocation)
 	if err != nil {
 		return fmt.Errorf("failed to create cacher: %w", err)
 	}
 
-	profileWatcher, err := watcher.NewWatcher(watcher.Options{
-		KubeClient:                    rawClient,
-		Cache:                         profileCache,
-		MetricsBindAddress:            options.WatcherMetricsBindAddress,
-		HealthzBindAddress:            options.WatcherHealthzBindAddress,
-		NotificationControllerAddress: options.NotificationControllerAddress,
-		WatcherPort:                   options.WatcherPort,
-	})
-	if err != nil {
-		return fmt.Errorf("failed to start the watcher: %w", err)
-	}
-
-	go func() {
-		if err := profileWatcher.StartWatcher(); err != nil {
-			log.Error(err, "failed to start profile watcher")
-			os.Exit(1)
-		}
-	}()
+	// profileWatcher, err := watcher.NewWatcher(watcher.Options{
+	// 	KubeClient:                    rawClient,
+	// 	Cache:                         profileCache,
+	// 	MetricsBindAddress:            options.WatcherMetricsBindAddress,
+	// 	HealthzBindAddress:            options.WatcherHealthzBindAddress,
+	// 	NotificationControllerAddress: options.NotificationControllerAddress,
+	// 	WatcherPort:                   options.WatcherPort,
+	// })
+	// if err != nil {
+	// 	return fmt.Errorf("failed to start the watcher: %w", err)
+	// }
+
+	// go func() {
+	// 	if err := profileWatcher.StartWatcher(); err != nil {
+	// 		log.Error(err, "failed to start profile watcher")
+	// 		os.Exit(1)
+	// 	}
+	// }()
 
 	profilesConfig := server.NewProfilesConfig(kube.ClusterConfig{
 		DefaultConfig: rest,
diff --git a/go.mod b/go.mod
index 382485ad..be9f6761 100644
--- a/go.mod
+++ b/go.mod
@@ -34,7 +34,7 @@ require (
 	github.com/onsi/ginkgo v1.16.4
 	github.com/onsi/gomega v1.16.0
 	github.com/ory/go-acc v0.2.6
-	github.com/pelletier/go-toml v1.9.4
+	github.com/pelletier/go-toml v1.9.4 // indirect
 	github.com/pkg/browser v0.0.0-20210706143420-7d21f8c997e2
 	github.com/pkg/errors v0.9.1
 	github.com/sclevine/agouti v0.0.0-20190613051229-00c1187c74ad
diff --git a/manifests/wego-app/deployment.yaml.tpl b/manifests/wego-app/deployment.yaml
similarity index 72%
rename from manifests/wego-app/deployment.yaml.tpl
rename to manifests/wego-app/deployment.yaml
index 26e6c487..079f576b 100644
--- a/manifests/wego-app/deployment.yaml.tpl
+++ b/manifests/wego-app/deployment.yaml
@@ -2,7 +2,7 @@ apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: wego-app
-  namespace: {{.Namespace}}
+  namespace: flux-system
 spec:
   replicas: 1
   template:
@@ -13,8 +13,8 @@ spec:
       serviceAccountName: wego-app-service-account
       containers:
         - name: wego-app
-          image: {{.AppImage}}:{{.AppVersion}}
-          args: ["ui", "run", "-l", "--helm-repo-namespace", "{{.Namespace}}"]
+          image: ghcr.io/weaveworks/weave-gitops:latest
+          args: ["ui", "run", "-l", "--helm-repo-namespace", "flux-system"]
           ports:
             - containerPort: 9001
               protocol: TCP
diff --git a/manifests/wego-app/helm_watcher_role.yaml.tpl b/manifests/wego-app/helm_watcher_role.yaml
similarity index 100%
rename from manifests/wego-app/helm_watcher_role.yaml.tpl
rename to manifests/wego-app/helm_watcher_role.yaml
diff --git a/manifests/wego-app/helm_watcher_role_binding.yaml.tpl b/manifests/wego-app/helm_watcher_role_binding.yaml
similarity index 89%
rename from manifests/wego-app/helm_watcher_role_binding.yaml.tpl
rename to manifests/wego-app/helm_watcher_role_binding.yaml
index 64f22461..85e34658 100644
--- a/manifests/wego-app/helm_watcher_role_binding.yaml.tpl
+++ b/manifests/wego-app/helm_watcher_role_binding.yaml
@@ -9,4 +9,4 @@ roleRef:
 subjects:
   - kind: ServiceAccount
     name: wego-app-service-account
-    namespace: {{ .Namespace }}
+    namespace: flux-system
diff --git a/manifests/wego-app/role-binding.yaml.tpl b/manifests/wego-app/role-binding.yaml
similarity index 80%
rename from manifests/wego-app/role-binding.yaml.tpl
rename to manifests/wego-app/role-binding.yaml
index 11b2fa47..199edb80 100644
--- a/manifests/wego-app/role-binding.yaml.tpl
+++ b/manifests/wego-app/role-binding.yaml
@@ -2,11 +2,11 @@ apiVersion: rbac.authorization.k8s.io/v1
 kind: RoleBinding
 metadata:
   name: read-resources
-  namespace: {{.Namespace}}
+  namespace: flux-system
 subjects:
   - kind: ServiceAccount
     name: wego-app-service-account
-    namespace: {{.Namespace}}
+    namespace: flux-system
 roleRef:
   kind: Role
   name: resources-reader
diff --git a/manifests/wego-app/role.yaml b/manifests/wego-app/role.yaml
new file mode 100644
index 00000000..96195754
--- /dev/null
+++ b/manifests/wego-app/role.yaml
@@ -0,0 +1,30 @@
+apiVersion: rbac.authorization.k8s.io/v1
+kind: Role
+metadata:
+  name: resources-reader
+  namespace: flux-system
+rules:
+  - apiGroups: [""]
+    resources: ["secrets"]
+    verbs: ["get", "create"]
+  - apiGroups: ["wego.weave.works"]
+    resources: ["apps"]
+    verbs: ["*"]
+  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
+    resources: ["kustomizations"]
+    verbs: ["*"]
+  - apiGroups: ["helm.toolkit.fluxcd.io"]
+    resources: ["helmreleases"]
+    verbs: ["*"]
+  - apiGroups: ["source.toolkit.fluxcd.io"]
+    resources: ["helmrepositories"]
+    verbs: ["*"]
+  - apiGroups: ["source.toolkit.fluxcd.io"]
+    resources: ["helmcharts"]
+    verbs: ["*"]
+  - apiGroups: ["source.toolkit.fluxcd.io"]
+    resources: ["gitrepositories"]
+    verbs: ["*"]
+  - apiGroups: ["apps"]
+    resources: ["deployments"]
+    verbs: ["*"]
diff --git a/manifests/wego-app/role.yaml.tpl b/manifests/wego-app/role.yaml.tpl
deleted file mode 100644
index 04bae5e0..00000000
--- a/manifests/wego-app/role.yaml.tpl
+++ /dev/null
@@ -1,27 +0,0 @@
-apiVersion: rbac.authorization.k8s.io/v1
-kind: Role
-metadata:
-  name: resources-reader
-  namespace: {{.Namespace}}
-rules:
-  - apiGroups: [""]
-    resources: ["secrets"]
-    verbs: ["get","create"]
-  - apiGroups: ["wego.weave.works"]
-    resources: [ "apps" ]
-    verbs: [ "*" ]
-  - apiGroups: ["kustomize.toolkit.fluxcd.io"]
-    resources: [ "kustomizations" ]
-    verbs: [ "*" ]
-  - apiGroups: ["helm.toolkit.fluxcd.io"]
-    resources: [ "helmreleases" ]
-    verbs: [ "*" ]
-  - apiGroups: ["source.toolkit.fluxcd.io"]
-    resources: [ "helmrepositories" ]
-    verbs: [ "*" ]
-  - apiGroups: ["source.toolkit.fluxcd.io"]
-    resources: [ "helmcharts" ]
-    verbs: [ "*" ]
-  - apiGroups: ["source.toolkit.fluxcd.io"]
-    resources: [ "gitrepositories" ]
-    verbs: [ "*" ]
diff --git a/manifests/wego-app/service-account.yaml.tpl b/manifests/wego-app/service-account.yaml
similarity index 82%
rename from manifests/wego-app/service-account.yaml.tpl
rename to manifests/wego-app/service-account.yaml
index 4026832f..ad74019b 100644
--- a/manifests/wego-app/service-account.yaml.tpl
+++ b/manifests/wego-app/service-account.yaml
@@ -2,6 +2,6 @@ apiVersion: v1
 kind: ServiceAccount
 metadata:
   name: wego-app-service-account
-  namespace: {{.Namespace}}
+  namespace: flux-system
 secrets:
   - name: wego-app-service-account-token
diff --git a/manifests/wego-app/service.yaml.tpl b/manifests/wego-app/service.yaml
similarity index 85%
rename from manifests/wego-app/service.yaml.tpl
rename to manifests/wego-app/service.yaml
index ceafa327..c13fce5d 100644
--- a/manifests/wego-app/service.yaml.tpl
+++ b/manifests/wego-app/service.yaml
@@ -2,7 +2,7 @@ apiVersion: v1
 kind: Service
 metadata:
   name: wego-app
-  namespace: {{.Namespace}}
+  namespace: flux-system
 spec:
   selector:
     app: wego-app
diff --git a/tools/wego-app-dev.yaml b/tools/wego-app-dev.yaml
index 6b9d6298..153d3840 100644
--- a/tools/wego-app-dev.yaml
+++ b/tools/wego-app-dev.yaml
@@ -1,14 +1,9 @@
 ---
-apiVersion: v1
-kind: Namespace
-metadata:
-  name: wego-system
----
 apiVersion: apps/v1
 kind: Deployment
 metadata:
   name: wego-app
-  namespace: wego-system
+  namespace: flux-system
 spec:
   replicas: 1
   template:
-- 
2.17.1

